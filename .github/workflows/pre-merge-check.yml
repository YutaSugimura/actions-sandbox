name: Prevent Outdated Merges

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  check-up-to-date:
    runs-on: ubuntu-latest
    steps:
      - name: Wait for GitHub to determine mergeability
        run: sleep 5  # GitHub„Ååmergeable„ÅÆÊÉÖÂ†±„ÇíÁ¢∫ÂÆö„Åô„Çã„Åæ„ÅßÂæÖ„Å§

      - name: Check if branch is up to date
        id: check
        run: |
          BASE_BRANCH="${{ github.event.pull_request.base.ref }}"
          HEAD_BRANCH="${{ github.event.pull_request.head.ref }}"
          OWNER_REPO="${{ github.repository }}"

          # API„Åã„ÇâPR„ÅÆË©≥Á¥∞ÊÉÖÂ†±„ÇíÂèñÂæó
          RESPONSE=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/$OWNER_REPO/pulls/${{ github.event.pull_request.number }}")

          echo "API Response: $RESPONSE"

          MERGEABLE=$(echo "$RESPONSE" | jq -r '.mergeable')
          MERGEABLE_STATE=$(echo "$RESPONSE" | jq -r '.mergeable_state')

          echo "Mergeable: $MERGEABLE"
          echo "Mergeable State: $MERGEABLE_STATE"

          if [[ "$MERGEABLE" == "null" ]]; then
            echo "GitHub is still processing mergeability status. Retrying..."
            sleep 5
            RESPONSE=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/$OWNER_REPO/pulls/${{ github.event.pull_request.number }}")
            MERGEABLE=$(echo "$RESPONSE" | jq -r '.mergeable')
            MERGEABLE_STATE=$(echo "$RESPONSE" | jq -r '.mergeable_state')
          fi

          if [[ "$MERGEABLE" == "false" || "$MERGEABLE_STATE" == "behind" ]]; then
            echo "‚ùå Branch is outdated! Please update your branch before merging."
            exit 1
          fi

      - name: Notify PR status
        if: failure()
        run: echo "üö® PR is outdated! Merge is blocked until updated."
