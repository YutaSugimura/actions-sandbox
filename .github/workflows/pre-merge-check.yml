name: Prevent Outdated Merges

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  check-up-to-date:
    runs-on: ubuntu-latest
    steps:
      - name: Check if branch is up to date
        id: check
        run: |
          BASE_BRANCH="${{ github.event.pull_request.base.ref }}"
          HEAD_BRANCH="${{ github.event.pull_request.head.ref }}"
          OWNER_REPO="${{ github.repository }}"

          # API„Åã„Çâ„Éû„Éº„Ç∏Áä∂ÊÖã„ÇíÂèñÂæó
          RESPONSE=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/$OWNER_REPO/pulls/${{ github.event.pull_request.number }}")

          MERGEABLE=$(echo "$RESPONSE" | jq -r '.mergeable')
          MERGEABLE_STATE=$(echo "$RESPONSE" | jq -r '.mergeable_state')

          echo "Mergeable: $MERGEABLE"
          echo "Mergeable State: $MERGEABLE_STATE"

          if [[ "$MERGEABLE" == "false" || "$MERGEABLE_STATE" == "behind" ]]; then
            echo "‚ùå Branch is outdated! Please update your branch before merging."
            exit 1
          fi

      - name: Notify PR status
        if: failure()
        run: echo "üö® PR is outdated! Merge is blocked until updated."
